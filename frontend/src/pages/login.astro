---
// Check if user is already logged in
if (Astro.cookies.get('user_id')) {
  return Astro.redirect('/dashboard');
}

const title = "EchoReal - Login";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="min-h-screen flex items-center justify-center bg-black text-white font-sans">
    <!-- Simple Login Container -->
    <div class="w-full max-w-md mx-4">
      <div class="bg-white border border-gray-300 rounded-lg p-8 shadow-lg">
        <!-- Header -->
        <div class="text-center mb-8">
          <div class="flex justify-center items-center mb-4">
            <img class="w-64 h-auto object-contain mx-auto" src="/Untitled_Artwork.gif" alt="Echo Journal Logo" />
          </div>
          <p class="text-gray-600">Sign in to your account</p>
        </div>

        <!-- Messages -->
        <div id="error-message" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-600 text-sm"></div>
        <div id="success-message" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded text-green-600 text-sm"></div>

        <!-- Form -->
        <form id="login-form" class="space-y-4">
          <!-- Email Field -->
          <div>
            <label for="email" class="block text-black text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              placeholder="Enter your email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg text-black placeholder-gray-400 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors duration-200"
            />
          </div>

          <!-- User ID Field -->
          <div>
            <label for="user_id" class="block text-black text-sm font-medium mb-2">User ID</label>
            <input 
              type="text" 
              id="user_id" 
              name="user_id" 
              placeholder="Or enter your user ID"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg text-black placeholder-gray-400 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors duration-200"
            />
          </div>

          <!-- Password Field -->
          <div>
            <label for="password" class="block text-black text-sm font-medium mb-2">Password</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              placeholder="Enter your password"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg text-black placeholder-gray-400 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors duration-200"
            />
          </div>

          <!-- Submit Button -->
          <button 
            type="submit" 
            class="submit-btn relative w-full py-3 px-4 bg-black text-white font-medium rounded-lg transition-colors duration-200 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 mt-6"
          >
            <span class="relative z-10">Sign In</span>
            <div class="loading-spinner absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-300">
              <div class="w-5 h-5 border-2 border-gray-300 border-t-white rounded-full animate-spin"></div>
            </div>
          </button>
        </form>
      </div>
    </div>

    <script>
      function showError(message: string) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.classList.remove('hidden');
        }
        const successDiv = document.getElementById('success-message');
        if (successDiv) {
          successDiv.classList.add('hidden');
        }
      }

      function showSuccess(message: string) {
        const successDiv = document.getElementById('success-message');
        if (successDiv) {
          successDiv.textContent = message;
          successDiv.classList.remove('hidden');
        }
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
          errorDiv.classList.add('hidden');
        }
      }

      function hideMessages() {
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
      }

      function setLoading(loading: boolean) {
        const form = document.getElementById('login-form');
        const button = document.querySelector('.submit-btn') as HTMLButtonElement;
        const spinner = document.querySelector('.loading-spinner');
        const buttonText = button?.querySelector('span');

        if (loading) {
          form?.classList.add('pointer-events-none', 'opacity-70');
          buttonText?.classList.add('opacity-0');
          spinner?.classList.remove('opacity-0');
        } else {
          form?.classList.remove('pointer-events-none', 'opacity-70');
          buttonText?.classList.remove('opacity-0');
          spinner?.classList.add('opacity-0');
        }
      }

      // Check if already logged in
      if (localStorage.getItem("user_id")) {
        window.location.href = "/";
      }

      document.getElementById("login-form")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideMessages();

        const emailEl = document.getElementById("email") as HTMLInputElement;
        const userIdEl = document.getElementById("user_id") as HTMLInputElement;
        const passwordEl = document.getElementById("password") as HTMLInputElement;

        const email = emailEl?.value?.trim() || '';
        const user_id = userIdEl?.value?.trim() || '';
        const password = passwordEl?.value || '';

        if (!password) {
          showError("Password is required.");
          return;
        }

        if (!email && !user_id) {
          showError("Please provide either an email or user ID.");
          return;
        }

        const payload: any = { password };
        if (email) payload.email = email;
        if (user_id) payload.user_id = user_id;

        setLoading(true);

        try {
          const res = await fetch("http://localhost:8000/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const err = await res.json();
            showError(err.detail || "Login failed. Please try again.");
            return;
          }

          const data = await res.json();
          const { session } = data;

          document.cookie = `user_id=${session.user_id}; path=/`;
          document.cookie = `currentDate=${session.currentDate}; path=/`;
          document.cookie = `expiryDate=${session.expiryDate}; path=/`;

          localStorage.setItem("user_id", session.user_id);

          showSuccess("Login successful! Redirecting...");
          
          window.location.href = "/dashboard";

        } catch (err) {
          console.error("Login error:", err);
          showError("Network error. Please check your connection and try again.");
        } finally {
          setLoading(false);
        }
      });
    </script>
  </body>
</html>
